<!-- requestDetail.html -->
<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>調査依頼 詳細</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    .page-title {
      letter-spacing: 0.04em;
    }

    .card {
      border: 0;
    }

    .section-title {
      font-weight: 600;
    }

    .kv {
      display: grid;
      grid-template-columns: 12rem 1fr;
      gap: 0.5rem 1rem;
    }

    .kv dt {
      color: var(--bs-secondary-color);
    }

    .kv dd {
      margin: 0;
    }

    .badge-entity {
      font-weight: 600;
      background: #eef2f5;
      color: #6c757d;
      border: 1px solid #cfd6dc;
    }

    .badge-entity.FG {
      background: #e7f1ff;
      color: #0d6efd;
      border-color: #b6d2ff;
    }

    .badge-entity.BK {
      background: #fef3e6;
      color: #fd7e14;
      border-color: #ffd7a8;
    }

    .badge-entity.OTB {
      background: #eaf7ef;
      color: #198754;
      border-color: #bfe6cd;
    }

    .badge-entity.SC {
      background: #f1e8ff;
      color: #6f42c1;
      border-color: #d7c6ff;
    }

    .badge-entity.TB {
      background: #fff3f4;
      color: #d63384;
      border-color: #ffc2cf;
    }

    .badge-soft {
      background: var(--bs-secondary-bg);
      border: 1px solid var(--bs-secondary-border-subtle);
    }

    .stepper {
      display: flex;
      gap: 1.25rem;
      flex-wrap: wrap;
    }

    .stepper .step {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--bs-secondary-color);
    }

    .stepper .step i {
      width: 1.5rem;
      height: 1.5rem;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--bs-secondary-border-subtle);
      background: var(--bs-secondary-bg);
    }

    .stepper .step.active {
      color: var(--bs-body-color);
    }

    .stepper .step.active i {
      border-color: rgba(var(--bs-primary-rgb), 0.45);
      background: rgba(var(--bs-primary-rgb), 0.12);
      color: var(--bs-primary);
    }

    .table-sm td,
    .table-sm th {
      padding: 0.5rem 0.75rem;
    }

    .muted {
      color: var(--bs-secondary-color);
    }

    .timeline {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }

    .timeline li {
      position: relative;
      padding-left: 1.5rem;
      margin: 0.5rem 0;
    }

    .timeline li::before {
      content: "";
      position: absolute;
      left: 0.5rem;
      top: 0.35rem;
      width: 0.5rem;
      height: 0.5rem;
      border-radius: 50%;
      background: var(--bs-primary);
    }

    .divider {
      height: 1px;
      background: var(--bs-border-color);
      opacity: 0.6;
      margin: 1rem 0;
    }

    .btn-icon {
      width: 2.25rem;
      height: 2.25rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    @media (max-width: 768px) {
      .kv {
        grid-template-columns: 8rem 1fr;
      }
    }
  </style>
</head>

<body class="bg-body-tertiary">
  <main class="container py-4">
    <!-- ヘッダーバー -->
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div class="d-flex align-items-center">
        <i class="bi bi-file-earmark-text fs-3 me-2 text-primary"></i>
        <h1 class="h4 page-title mb-0">調査依頼 詳細</h1>
      </div>
      <div class="d-flex gap-2">
        <a class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> 一覧へ</a>
      </div>
    </div>

    <!-- 概要カード -->
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-lg-7">
            <div class="kv">
              <dt>依頼No.</dt>
              <dd class="fw-semibold">1234</dd>
              <dt>応募者 / 対象者</dt>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- コンテンツ：各工程 -->
    <form>
      <div class="row g-3">
        <!-- 同意書（表示のみ） -->
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="section-title mb-2">
                <i class="bi bi-file-check"></i> 同意書
              </div>
              <div class="row g-3">
                <div class="col-12 d-flex align-items-center gap-2">
                  <label class="form-label mb-0" style="width: 100px;">取得依頼</label>
                  <div class="form-check form-switch">
                    <input id="requestCheckbox_1" class="form-check-input" type="checkbox" />
                  </div>
                  <input id="requestDate_1" type="date" class="form-control w-auto" style="max-width: 200px;" />
                </div>
                <div class="col-12 d-flex align-items-center gap-2">
                  <label class="form-label mb-0" style="width: 100px;">本人へ依頼中</label>
                  <div class="form-check form-switch">
                    <input id="requestCheckbox_2" class="form-check-input" type="checkbox" />
                  </div>
                  <input id="requestDate_2" type="date" class="form-control w-auto" style="max-width: 200px;" />
                </div>
                <div class="col-12 d-flex align-items-center gap-2">
                  <label class="form-label mb-0" style="width: 100px;">取得</label>
                  <div class="form-check form-switch">
                    <input id="requestCheckbox_3" class="form-check-input" type="checkbox" />
                  </div>
                  <input id="requestDate_3" type="date" class="form-control w-auto" style="max-width: 200px;" />
                </div>
                <div class="col-12 d-flex align-items-center gap-2">
                  <label class="form-label mb-0" style="width: 100px;">メールアドレス</label>
                  <input type="text" class="form-control" style="max-width: 300px;" />
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- データチェック（編集可） -->
        <div class="col-12">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <div class="row g-3">
                <!-- 左：データチェック -->
                <div class="col-12 col-lg-6">
                  <div class="section-title mb-2">
                    <i class="bi bi-clipboard-check"></i> データチェック
                  </div>
                  <div class="row g-3">
                    <div class="col-6">
                      <label class="form-label">依頼</label>
                      <div class="d-flex align-items-center gap-2">
                        <div class="form-check form-switch">
                          <input id="requestCheckbox_4" class="form-check-input" type="checkbox" />
                        </div>
                        <input id="requestDate_4" type="date" class="form-control w-auto" style="max-width:200px;" />
                      </div>
                    </div>
                    <div class="col-6">
                      <label class="form-label">完了</label>
                      <div class="d-flex align-items-center gap-2">
                        <div class="form-check form-switch">
                          <input id="requestCheckbox_5" class="form-check-input" type="checkbox" />
                        </div>
                        <input id="requestDate_5" type="date" class="form-control w-auto" style="max-width:200px;" />
                      </div>
                    </div>
                  </div>
                </div>

                <!-- 右：備考 -->
                <div class="col-12 col-lg-6">
                  <div class="section-title mb-2">備考</div>
                  <textarea class="form-control" rows="5"></textarea>
                </div>
              </div>
            </div>
          </div>
        </div>



        <!-- バックグラウンドチェック（編集可） -->
        <div class="col-12">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <div class="row g-3">
                <!-- 左：バックグラウンドチェック -->
                <div class="col-12 col-lg-6">
                  <div class="section-title mb-2">
                    <i class="bi bi-search"></i> バックグラウンドチェック
                  </div>
                  <div class="row g-3">
                    <div class="col-12 col-md-4">
                      <label class="form-label">依頼</label>
                      <div class="d-flex align-items-center gap-2">
                        <div class="form-check form-switch">
                          <input id="requestCheckbox_6" class="form-check-input" type="checkbox" />
                        </div>
                        <input id="requestDate_6" type="date" class="form-control w-auto" style="max-width:200px;" />
                      </div>
                    </div>
                    <div class="col-12 col-md-4">
                      <label class="form-label">調査開始</label>
                      <div class="d-flex align-items-center gap-2">
                        <div class="form-check form-switch">
                          <input id="requestCheckbox_7" class="form-check-input" type="checkbox" />
                        </div>
                        <input id="requestDate_7" type="date" class="form-control w-auto" style="max-width:200px;" />
                      </div>
                    </div>
                    <div class="col-12 col-md-4">
                      <label class="form-label">完了</label>
                      <div class="d-flex align-items-center gap-2">
                        <div class="form-check form-switch">
                          <input id="requestCheckbox_8" class="form-check-input" type="checkbox" />
                        </div>
                        <input id="requestDate_8" type="date" class="form-control w-auto" style="max-width:200px;" />
                      </div>
                    </div>
                  </div>
                </div>

                <!-- 右：備考 -->
                <div class="col-12 col-lg-6">
                  <div class="section-title mb-2">備考</div>
                  <textarea class="form-control" rows="5"></textarea>
                </div>
              </div>
            </div>
          </div>
        </div>


        <!-- 現職の詳細確認（編集可） -->
        <div class="col-12">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <div class="row g-3">
                <!-- 左：現職の詳細確認 -->
                <div class="col-12 col-lg-6">
                  <div class="section-title mb-2">
                    <i class="bi bi-clipboard-check"></i> 現職の詳細確認
                  </div>
                  <div class="row g-3">
                    <div class="col-6">
                      <label class="form-label">ご本人了承</label>
                      <div class="d-flex align-items-center gap-2">
                        <div class="form-check form-switch">
                          <input id="requestCheckbox_9" class="form-check-input" type="checkbox" />
                        </div>
                        <input id="requestDate_9" type="date" class="form-control w-auto" style="max-width:200px;" />
                      </div>
                    </div>
                    <div class="col-6">
                      <label class="form-label">完了</label>
                      <div class="d-flex align-items-center gap-2">
                        <div class="form-check form-switch">
                          <input id="requestCheckbox_10" class="form-check-input" type="checkbox" />
                        </div>
                        <input id="requestDate_10" type="date" class="form-control w-auto" style="max-width:200px;" />
                      </div>
                    </div>
                  </div>
                </div>

                <!-- 右：備考 -->
                <div class="col-12 col-lg-6">
                  <div class="section-title mb-2">備考</div>
                  <textarea class="form-control" rows="5"></textarea>
                </div>
              </div>
            </div>
          </div>
        </div>


        <!-- リファレンスインタビュー（編集可：行追加/削除） -->
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="section-title">
                  <i class="bi bi-people"></i> リファレンスインタビュー
                </div>
                <div>
                  <!-- 依頼済み（オプションのヘッダ側スイッチの見た目デモ） -->
                  <div class="d-inline-flex align-items-center gap-4">
                    <div>
                      <label class="form-label mb-1">依頼済み</label>
                      <div class="d-flex align-items-center gap-3">
                        <div class="form-check form-switch mb-0">
                          <input id="requestCheckbox_11" class="form-check-input" type="checkbox" />
                        </div>
                        <input id="requestDate_11" type="date" class="form-control w-auto" style="max-width:200px;" />
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="table-responsive">
                <table class="table table-sm align-middle">
                  <thead class="text-secondary">
                    <tr>
                      <th style="width: 6rem">No</th>
                      <th style="width: 12rem">回答者</th>
                      <th style="width: 9rem">日付</th>
                      <th style="width: 10rem">完了/日付</th>
                      <th style="width: 18rem">企業名</th>
                      <th style="width: 6rem">人数</th>
                      <th style="width: 21rem">備考</th>
                      <th style="width: 3rem"></th>
                    </tr>
                  </thead>
                  <tbody id="refBody">
                    <!-- 初期0件（ここにJSで行が追加されます） -->
                  </tbody>
                </table>
              </div>

              <button type="button" class="btn btn-outline-primary" id="addRef">
                <i class="bi bi-plus-lg"></i> 追加
              </button>
            </div>
          </div>
        </div>

        <!-- 追加行テンプレート（純HTML） -->
        <template id="refRowTemplate">
          <tr data-index="__index__">
            <td class="no">__no__</td>
            <td>
              <input type="text" class="form-control" name="references[__index__].name">
            </td>
            <td>
              <input type="date" class="form-control" name="references[__index__].date">
            </td>
            <td>
              <div class="d-flex align-items-center gap-2">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="ref_done___index__"
                    name="references[__index__].done">
                </div>
                <input type="date" class="form-control w-auto" style="max-width:200px;" id="ref_doneAt___index__"
                  name="references[__index__].doneAt">
              </div>
            </td>
            <td>
              <input type="text" class="form-control" name="references[__index__].company">
            </td>
            <td>
              <input type="number" class="form-control" name="references[__index__].count" min="0">
            </td>
            <td>
              <input type="text" class="form-control" name="references[__index__].remark">
            </td>
            <td class="text-end">
              <button type="button" class="btn btn-outline-danger btn-sm remove-ref" title="削除">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          </tr>
        </template>

        <!-- 個別連絡 / 依頼辞退（編集可） -->
        <div class="col-12 col-lg-6">
          <div class="card shadow-sm mb-3">
            <div class="card-body">
              <div class="section-title mb-2">
                <i class="bi bi-chat-left-text"></i> 個別連絡
              </div>
              <div class="row g-3">
                <div class="col-md-12">
                  <label class="form-label">メモ</label>
                  <input type="text" class="form-control" />
                </div>
              </div>
            </div>
          </div>

          <div class="card shadow-sm mb-3">
            <div class="card-body">
              <div class="section-title mb-2">
                <i class="bi bi-clipboard-check"></i> タスク完了
              </div>
              <div class="row g-3">
                <div class="col-12 col-md-4">
                  <label class="form-label">完了</label>
                  <div class="d-flex align-items-center gap-2">
                    <div class="form-check form-switch">
                      <input id="requestCheckbox_12" class="form-check-input" type="checkbox" />
                    </div>
                    <input id="requestDate_12" type="date" class="form-control w-auto" style="max-width:200px;" />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="card shadow-sm">
            <div class="card-body">
              <div class="section-title mb-2">
                <i class="bi bi-slash-circle"></i> 依頼辞退
              </div>
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">状況</label>
                  <select class="form-select">
                    <option value="">―</option>
                    <option>保留</option>
                    <option>中止</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">日付</label>
                  <input type="date" class="form-control" />
                </div>
                <div class="col-12">
                  <label class="form-label">理由</label>
                  <textarea class="form-control" rows="2"></textarea>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 右下：添付/履歴（表示のみ）→そのまま -->
        <!-- ・・・必要なら前回の表示カードを残してください・・・ -->
      </div>

      <!-- フッタ操作（保存） -->
      <div class="d-flex justify-content-between mt-3">
        <a class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> 一覧へ戻る</a>
        <div class="d-flex gap-2">
          <button type="reset" class="btn btn-outline-secondary">
            リセット
          </button>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-save"></i> 保存
          </button>
        </div>
      </div>
    </form>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (function () {
      const MAX_ROWS = 3;
      const tbody = document.getElementById('refBody');
      const addBtn = document.getElementById('addRef');
      const tpl = document.getElementById('refRowTemplate');

      if (!tbody || !addBtn || !tpl) return;

      // チェックONで本日日付、OFFでクリア
      function bindCheckboxAutoDate(tr) {
        const done = tr.querySelector('input[type="checkbox"][name^="references"][name$=".done"]');
        const doneAt = tr.querySelector('input[type="date"][name^="references"][name$=".doneAt"]');
        if (!done || !doneAt) return;

        done.addEventListener('change', () => {
          if (done.checked) {
            const today = new Date().toISOString().split('T')[0];
            doneAt.value = today;
          } else {
            doneAt.value = '';
          }
        });
      }

      // No振り直し & name/idのindex更新 & 追加ボタン制御
      function renumber() {
        const rows = [...tbody.querySelectorAll('tr')];
        rows.forEach((tr, idx) => {
          tr.dataset.index = idx;
          const noCell = tr.querySelector('.no');
          if (noCell) noCell.textContent = idx + 1;

          tr.querySelectorAll('[name]').forEach(el => {
            el.name = el.name.replace(/references\[\d+]/, `references[${idx}]`);
          });
          tr.querySelectorAll('[id]').forEach(el => {
            el.id = el.id
              .replace(/ref_doneAt_\d+/, `ref_doneAt_${idx}`)
              .replace(/ref_done_\d+/, `ref_done_${idx}`);
          });
        });
        addBtn.disabled = rows.length >= MAX_ROWS;
      }

      function addRow() {
        const count = tbody.querySelectorAll('tr').length;
        if (count >= MAX_ROWS) return;

        const html = tpl.innerHTML
          .replaceAll('__index__', count)
          .replaceAll('__no__', count + 1);

        const wrap = document.createElement('tbody');
        wrap.innerHTML = html.trim();
        const tr = wrap.firstElementChild;

        tbody.appendChild(tr);
        bindCheckboxAutoDate(tr);
        renumber();
      }

      // 初期（0件）状態セット
      renumber();

      // 追加
      addBtn.addEventListener('click', addRow);

      // 削除
      tbody.addEventListener('click', (e) => {
        const btn = e.target.closest('.remove-ref');
        if (!btn) return;
        const tr = btn.closest('tr');
        tr?.remove();
        renumber();
      });
    })();
  </script>
  <script>
    for (let i = 1; i <= 12; i++) {
      document
        .getElementById("requestCheckbox_" + i)
        .addEventListener("change", () => {
          if (document.getElementById("requestCheckbox_" + i).checked) {
            // 今日の日付を YYYY-MM-DD 形式でセット
            const today = new Date().toISOString().split("T")[0];
            document.getElementById("requestDate_" + i).value = today;
          } else {
            // チェック外したら日付をクリア
            document.getElementById("requestDate_" + i).value = "";
          }
        });
    }
  </script>
</body>

</html>
